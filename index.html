<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estoque & Compras</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%231E1E1E%22/><text x=%2250%22 y=%2268%22 font-size=%2250%22 text-anchor=%22middle%22>üõí</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%231E1E1E%22/><text x=%2250%22 y=%2268%22 font-size=%2250%22 text-anchor=%22middle%22>üõí</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Estoque">

    <style>
        :root {
            --bg: #121212; --card: #1E1E1E; --text: #E0E0E0; --border: #444444; 
            --accent: #888888; --highlight: #2C2C2C; --edit-bg: #2A2A20;
            --shop-bg: #2C1A1A; --borda-caixas: #555555; 
            
            --btn-add: #E0E0E0; --btn-add-text: #121212;
            --btn-red: #B91C1C;    
            --btn-green: #047857;  
            --btn-blue: #1D4ED8;   
            --btn-purple: #6D28D9; 
            --btn-danger: #EF4444; 
        }

        body.light-mode {
            --bg: #F0F2F5; --card: #FFFFFF; --text: #121212; --border: #D1D5DB;
            --accent: #4B5563; --highlight: #E5E7EB; --edit-bg: #F9FAFB;
            --shop-bg: #FCE7F3; --borda-caixas: #9CA3AF;
            
            --btn-add: #121212; --btn-add-text: #FFFFFF;
            --btn-red: #EF4444;    
            --btn-green: #10B981;  
            --btn-blue: #3B82F6;   
            --btn-purple: #8B5CF6; 
            --btn-danger: #DC2626; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { font-family: 'Inter', sans-serif; font-weight: 600; max-width: 100%; margin: 0; padding: 10px; background-color: var(--bg); color: var(--text); padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        
        .header-container { display: flex; justify-content: center; align-items: center; position: relative; margin: 10px 0; }
        h1 { color: #FFFFFF; margin: 0; font-weight: 800; font-size: 16px; text-transform: uppercase; transition: color 0.3s; }
        body.light-mode h1 { color: #111827; }
        .btn-theme { position: absolute; right: 0; background: none; border: none; font-size: 22px; cursor: pointer; padding: 5px; outline: none; }

        .card { background: var(--card); padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 12px; transition: all 0.3s; }
        label { font-size: 9px; margin-bottom: 4px; display: block; color: var(--accent); text-transform: uppercase; }
        
        input[type="text"], select { padding: 8px 10px; background-color: var(--highlight); border: 1px solid var(--borda-caixas); border-radius: 6px; font-weight: 700; color: var(--text); font-size: 16px; width: 100%; outline: none; transition: border 0.3s, background-color 0.3s, color 0.3s; }
        input[type="text"]:focus, select:focus { border: 1px solid var(--accent); }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; margin: 0; accent-color: var(--btn-danger); }
        
        select {
            text-align: center;
            text-align-last: center;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23888888' opacity='0.4'%3E%3Cpath d='M7 15l5 5 5-5H7zM7 9l5-5 5 5H7z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 2px center;
            background-size: 14px;
        }

        button:active, .btn-nav:active, input[type="checkbox"]:active, .btn-theme:active { 
            transform: scale(0.92); 
            transition: transform 0.1s ease; 
        }

        .search-container { display: flex; gap: 6px; margin-bottom: 8px; }
        .input-group { display: grid; grid-template-columns: 1.5fr 0.7fr 0.8fr; gap: 6px; align-items: end; }
        button { padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 800; text-transform: uppercase; font-size: 11px; transition: transform 0.1s ease, background-color 0.3s, color 0.3s; }
        
        #add-btn { background-color: var(--btn-add); color: var(--btn-add-text); grid-column: span 3; margin-top: 4px; }
        
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 10px; overflow: hidden; border: 1px solid var(--border); table-layout: fixed; transition: all 0.3s; }
        th { background-color: var(--highlight); color: var(--accent); text-align: left; padding: 10px; font-size: 10px; text-transform: uppercase; transition: all 0.3s; }
        td { border-bottom: 1px solid var(--border); padding: 8px 6px; font-size: 13px; vertical-align: middle; word-wrap: break-word; overflow-wrap: break-word; transition: all 0.3s; }
        
        .col-check { width: 35px; text-align: center; }
        .col-desc { width: auto; } 
        .col-qtd { width: 85px; text-align: center; } 
        .col-unid { width: 70px; }
        .col-del { width: 35px; text-align: center; }

        .nome-prod { line-height: 1.2; display: block; outline: none; border: 1px solid transparent; border-radius: 4px; padding: 2px; }
        .nome-prod:focus { border: 1px dashed var(--borda-caixas); }
        .linha-marcada .nome-prod { color: var(--btn-danger); text-decoration: line-through; opacity: 0.8; }

        .input-qtd-tabela { background-color: var(--edit-bg); color: #FFFFB0; text-align: center; border-radius: 4px; width: 100%; border: 1px solid var(--borda-caixas); padding: 4px 2px; font-size: 16px; font-weight: bold; outline: none; transition: all 0.3s; }
        .input-qtd-tabela:focus { border: 1px solid var(--btn-danger); }
        body.light-mode .input-qtd-tabela { color: #B45309; } 

        .select-tabela { text-align: center; text-align-last: center; background: var(--edit-bg); border: 1px solid var(--borda-caixas); border-radius: 4px; color: var(--text); font-weight: 700; width: 100%; font-size: 16px; padding: 4px 2px; outline: none; transition: all 0.3s; }
        .select-tabela:focus { border: 1px solid var(--accent); }

        .btn-remove { background: transparent; color: var(--btn-danger); opacity: 0.5; font-size: 14px; width: 100%; border: none; padding: 0; transition: opacity 0.3s, transform 0.1s ease; }
        .share-group { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 12px; }
        .btn-zap { background-color: var(--highlight); color: var(--text); border: 1px solid var(--border); padding: 12px; }
        
        #area-compras { margin-top: 30px; background-color: var(--shop-bg); border: 1px solid #442222; padding: 15px; border-radius: 10px; display: none; transition: all 0.3s; }
        body.light-mode #area-compras { border: 1px solid #FBCFE8; }
        #titulo-compras { margin: 0 0 10px 0; font-size: 14px; color: var(--btn-danger); text-transform: uppercase; border-bottom: 1px solid #553333; padding-bottom: 5px; }
        body.light-mode #titulo-compras { border-bottom: 1px solid #FBCFE8; }
        #lista-compras-visual { list-style: none; padding: 0; margin: 0 0 15px 0; }
        #lista-compras-visual li { padding: 4px 0; border-bottom: 1px dashed var(--border); font-size: 13px; }

        .btn-compra { background-color: var(--btn-red); color: white; border: none; }
        #btn-novo-dia { background-color: var(--btn-green); color: white; border: none; width: 100%; margin-top: 20px; padding: 15px; font-size: 12px; }
        #btn-exportar { background-color: var(--btn-blue); color: white; border: none; width: 100%; margin-top: 10px; padding: 15px; font-size: 12px; }
        #btn-importar { background-color: var(--btn-purple); color: white; border: none; width: 100%; margin-top: 10px; padding: 15px; font-size: 12px; }
        #btn-reset { background: transparent; color: var(--btn-danger); border: 1px solid var(--btn-danger); width: 100%; margin-top: 20px; font-size: 10px; padding: 10px; opacity: 0.8; }

        .nav-float { position: fixed; right: 10px; bottom: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 100; }
        .btn-nav { width: 38px; height: 38px; border-radius: 50%; background-color: var(--card); color: var(--accent); border: 1px solid var(--border); font-size: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        #status-save { text-align: right; font-size: 8px; color: var(--btn-green); margin-top: 4px; opacity: 0; transition: opacity 0.3s; }

        @keyframes pulso-gravando { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .mic-ativo { animation: pulso-gravando 1.5s infinite; background-color: var(--btn-danger) !important; color: white !important;}

        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #333333; color: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); font-size: 13px; font-weight: bold; border: 1px solid #555; opacity: 0; animation: fadeToast 0.3s forwards; }
        body.light-mode .toast { background: #111827; }
        @keyframes fadeToast { to { opacity: 1; transform: translateY(-10px); } }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(2px); }
        .modal-box { background: var(--card); padding: 25px 20px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        #modal-text { font-size: 15px; margin-bottom: 25px; line-height: 1.4; color: var(--text); white-space: pre-wrap; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons button { flex: 1; padding: 12px; font-size: 12px; }
        #modal-btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--accent); }
        #modal-btn-confirm { background-color: var(--btn-danger); color: white; border: none; }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <div id="modal-confirm" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <div id="modal-text">Mensagem</div>
            <div class="modal-buttons">
                <button id="modal-btn-cancel" onclick="fecharModal(); darFeedback()">Cancelar</button>
                <button id="modal-btn-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="header-container">
        <h1 id="titulo-pagina">CONTROLE ESTOQUE</h1>
        <button class="btn-theme" onclick="alternarTema()">üåì</button>
    </div>

    <div class="card">
        <div class="search-container">
            <input type="text" id="filtroBusca" placeholder="üîç Buscar..." oninput="filtrarGeral()">
            <select id="filtroSelect" style="max-width: 100px;" onchange="filtrarGeral()">
                <option value="">üìÇ ITENS</option>
            </select>
        </div>
        <hr style="border: 0; border-top: 1px solid var(--border); margin: 10px 0;">
        <div class="input-group">
            <div style="position: relative;">
                <label>Produto</label>
                <input type="text" id="novoProduto" placeholder="Item" oninput="autoPreencherUnidade()" style="padding-right: 35px;">
                <div id="btn-mic" onclick="iniciarReconhecimentoVoz()" style="position: absolute; right: 4px; bottom: 4px; font-size: 16px; cursor: pointer; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">üéôÔ∏è</div>
            </div>
            <div>
                <label>Qtd</label>
                <input type="text" id="novoQtd" placeholder="1/2" onblur="calcularMath(this)" ondblclick="duploCliqueQtd(this)">
            </div>
            <div>
                <label>Unid</label>
                <select id="novoUnidade">
                    <option value="kg">kg</option><option value="g">g</option><option value="uni">uni</option>
                    <option value="pct">pct</option><option value="cx">cx</option><option value="bld">bld</option><option value="crt">crt</option>
                </select>
            </div>
            <button id="add-btn" onclick="adicionarManual()">ADICIONAR</button>
        </div>
        <div id="status-save">Salvo.</div>
    </div>

    <table id="tabela-estoque">
        <thead>
            <tr>
                <th class="col-check">üõí</th><th class="col-desc">Descri√ß√£o</th><th class="col-qtd">Qtd</th><th class="col-unid">Unid</th><th class="col-del"></th>
            </tr>
        </thead>
        <tbody id="lista-itens"></tbody>
    </table>

    <div class="share-group" style="margin-bottom: 20px;">
        <button class="btn-zap" onclick="darFeedback(); compartilharEstoque()">Enviar Estoque</button>
        <button id="btn-copiar" class="btn-zap" onclick="copiarEstoque()">Copiar Estoque</button>
    </div>

    <div id="area-compras">
        <h2 id="titulo-compras">LISTA DE COMPRAS</h2>
        <ul id="lista-compras-visual"></ul>
        <div class="share-group">
            <button class="btn-compra" onclick="darFeedback(); compartilharComprasZap()">WhatsApp Compras</button>
            <button class="btn-compra" onclick="copiarCompras()">Copiar Compras</button>
        </div>
    </div>

    <button id="btn-novo-dia" onclick="iniciarNovoDia()">‚òÄ INICIAR NOVO DIA (ZERAR QTD)</button>
    <button id="btn-exportar" onclick="salvarListaNoCelular()">üíæ SALVAR LISTA NO CELULAR</button>
    <button id="btn-importar" onclick="darFeedback(); document.getElementById('input-arquivo').click()">üìÇ CARREGAR LISTA DO CELULAR</button>
    <button id="btn-reset" onclick="resetarTudo()">‚ö† RESTAURAR LISTA PADR√ÉO</button>
    <input type="file" id="input-arquivo" accept=".json" style="display: none;" onchange="carregarListaDoCelular(event)">

    <div class="nav-float">
        <button class="btn-nav" onclick="darFeedback(); window.scrollTo(0,0)">‚ñ≤</button>
        <button class="btn-nav" onclick="darFeedback(); window.scrollTo(0, document.body.scrollHeight)">‚ñº</button>
    </div>

    <script>
        let audioCtx = null;

        function darFeedback() {
            if (navigator.vibrate) { navigator.vibrate(15); } 
            try {
                if (!audioCtx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioCtx = new AudioContext();
                }
                if (audioCtx.state === 'suspended') { audioCtx.resume(); }

                const osc = audioCtx.createOscillator(); 
                const gain = audioCtx.createGain();
                
                osc.type = 'sine'; 
                osc.frequency.setValueAtTime(800, audioCtx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.02);
                
                gain.gain.setValueAtTime(0.15, audioCtx.currentTime); 
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.02);
                
                osc.connect(gain); 
                gain.connect(audioCtx.destination); 
                
                osc.start(audioCtx.currentTime); 
                osc.stop(audioCtx.currentTime + 0.03);
            } catch (e) {}
        }

        function alternarTema() {
            darFeedback(); document.body.classList.toggle('light-mode');
            localStorage.setItem('temaEstoque', document.body.classList.contains('light-mode') ? 'claro' : 'escuro');
        }

        let acaoConfirmacao = null;

        function mostrarToast(msg) {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            toast.className = 'toast'; toast.innerText = msg; container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function mostrarConfirmacao(msg, callback, tipoBotao = 'perigo') {
            darFeedback(); document.getElementById('modal-text').innerText = msg;
            const btnCancel = document.getElementById('modal-btn-cancel'); const btnConfirm = document.getElementById('modal-btn-confirm');
            btnCancel.style.display = 'block'; btnCancel.innerText = 'Cancelar'; btnConfirm.style.display = 'block'; btnConfirm.innerText = 'Confirmar';
            btnConfirm.style.backgroundColor = (tipoBotao === 'sucesso') ? 'var(--btn-green)' : 'var(--btn-red)';
            document.getElementById('modal-confirm').style.display = 'flex'; acaoConfirmacao = callback;
        }

        function mostrarAlertaElegante(msg) {
            darFeedback(); document.getElementById('modal-text').innerText = msg;
            const btnCancel = document.getElementById('modal-btn-cancel'); const btnConfirm = document.getElementById('modal-btn-confirm');
            btnCancel.style.display = 'none'; btnConfirm.style.display = 'block'; btnConfirm.innerText = 'OK';
            btnConfirm.style.backgroundColor = 'var(--btn-blue)'; document.getElementById('modal-confirm').style.display = 'flex'; acaoConfirmacao = null; 
        }

        function fecharModal() { document.getElementById('modal-confirm').style.display = 'none'; acaoConfirmacao = null; }

        document.getElementById('modal-btn-confirm').addEventListener('click', () => {
            darFeedback(); if(acaoConfirmacao) acaoConfirmacao(); fecharModal();
        });

        function obterDataAtual() { return new Date().toLocaleDateString('pt-BR'); }
        function obterDataAmanha() { let hoje = new Date(); let amanha = new Date(hoje); amanha.setDate(hoje.getDate() + 1); return amanha.toLocaleDateString('pt-BR'); }
        
        function atualizarTitulos() { 
            document.getElementById("titulo-pagina").innerText = "ESTOQUE " + obterDataAtual(); 
            document.getElementById("titulo-compras").innerText = "LISTA " + obterDataAmanha(); 
        }

        var produtosPadrao = ["4 queijos|kg", "A√ß√∫car|kg", "Alho frito|pct", "Azeitona|uni", "Bacon|kg", "Banana|kg", "Batata palha|pct", "Caixa|uni", "Calabresa|kg", "Canela|pct", "Carne|kg", "Cebola|kg", "Cheddar|uni", "Chocolate branco|kg", "Chocolate preto|kg", "Colorau|pct", "Detergente|uni", "Esponja|uni", "Fermento|uni", "Frango cozido|kg", "Frango cru|kg", "Fub√°|kg", "Gelo|pct", "Milho|uni", "Molho|uni", "Mussarela|kg", "√ìleo|uni", "Or√©gano|pct", "Ovo|uni", "Palha de a√ßo|uni", "Papel toalhas|uni", "Pl√°stico filme|uni", "Presunto|kg", "Requeij√£o|uni", "Saco p lixo|uni", "Saco pl√°stico|uni", "Sal|kg", "Strogonoff|kg", "Tempero caldo de carne|cx", "Tempero caldo de frango|cx", "Tempero em p√≥ carne|cx", "Tempero em p√≥ frango|cx", "Trigo|kg"];

        var tbody = document.getElementById("lista-itens");
        var selectFiltro = document.getElementById("filtroSelect");
        var buscaInput = document.getElementById("filtroBusca");
        var areaCompras = document.getElementById("area-compras");
        var ulCompras = document.getElementById("lista-compras-visual");

        function iniciarApp() {
            if(localStorage.getItem('temaEstoque') === 'claro') { document.body.classList.add('light-mode'); }
            atualizarTitulos();
            var salvos = localStorage.getItem("estoqueDados_v3");
            if (salvos && JSON.parse(salvos).length > 0) {
                var dados = JSON.parse(salvos); dados.sort((a, b) => a.n.localeCompare(b.n)); dados.forEach(i => inserirLinha(i.n, i.q, i.u, i.c || false));
            } else {
                produtosPadrao.sort().forEach(p => { var d = p.split("|"); inserirLinha(d[0], "", d[1], false); });
            }
            atualizarDropdown(); atualizarPainelCompras(); 
        }

        function duploCliqueQtd(inputElement) {
            darFeedback(); var valor = inputElement.value.trim().replace(',', '.'); var num = parseFloat(valor);
            if (isNaN(num)) { inputElement.value = "1"; } else { inputElement.value = (num + 1).toString().replace('.', ','); }
            salvarDados(); mostrarToast("+1 Adicionado!");
        }

        function calcularMath(inputElement) {
            var valor = inputElement.value.trim();
            if (valor.includes('+') || valor.includes('-')) {
                try {
                    var expressao = valor.replace(/,/g, '.').replace(/[^0-9\+\-\.\s]/g, '');
                    if(expressao !== "") {
                        var resultado = Function('"use strict";return (' + expressao + ')')();
                        resultado = Math.round(resultado * 100) / 100;
                        inputElement.value = resultado.toString().replace('.', ','); salvarDados();
                    }
                } catch (e) {}
            }
        }

        function salvarDados() {
            var dados = [];
            document.querySelectorAll("#lista-itens tr").forEach(r => {
                var c = r.querySelectorAll("td");
                dados.push({ 
                    n: c[1].innerText.replace(/(\r\n|\n|\r)/gm, " ").trim(), q: c[2].querySelector("input").value.trim(), 
                    u: c[3].querySelector("select").value, c: c[0].querySelector("input[type='checkbox']").checked
                });
            });
            localStorage.setItem("estoqueDados_v3", JSON.stringify(dados));
            var s = document.getElementById("status-save"); s.style.opacity = "1"; setTimeout(() => s.style.opacity = "0", 1500);
            atualizarPainelCompras();
        }

        function inserirLinha(n, q, u, chk) {
            var tr = document.createElement("tr");
            if(chk) tr.classList.add("linha-marcada");
            tr.innerHTML = `
                <td class="col-check"><input type="checkbox" onchange="alternarCheck(this)" ${chk ? 'checked' : ''}></td>
                <td class="col-desc"><span contenteditable="true" class="nome-prod" onblur="salvarEOrdenar()">${n}</span></td>
                <td class="col-qtd"><input type="text" class="input-qtd-tabela" value="${q}" oninput="salvarDados()" onblur="calcularMath(this)" ondblclick="duploCliqueQtd(this)"></td>
                <td class="col-unid"><select class="select-tabela" onchange="salvarDados()">
                    <option value="kg" ${u==='kg'?'selected':''}>kg</option><option value="g" ${u==='g'?'selected':''}>g</option>
                    <option value="uni" ${u==='uni'?'selected':''}>uni</option><option value="pct" ${u==='pct'?'selected':''}>pct</option>
                    <option value="cx" ${u==='cx'?'selected':''}>cx</option><option value="bld" ${u==='bld'?'selected':''}>bld</option>
                    <option value="crt" ${u==='crt'?'selected':''}>crt</option>
                </select></td>
                <td class="col-del"><button class="btn-remove" onclick="removerItem(this)">üóëÔ∏è</button></td>
            `;
            tbody.appendChild(tr);
        }

        function alternarCheck(box) {
            darFeedback(); var linha = box.parentElement.parentElement;
            if(box.checked) { linha.classList.add("linha-marcada"); } else { linha.classList.remove("linha-marcada"); }
            salvarDados(); 
        }

        function atualizarPainelCompras() {
            ulCompras.innerHTML = ""; var temItens = false;
            document.querySelectorAll("#lista-itens tr").forEach(r => {
                var checkbox = r.querySelector("input[type='checkbox']");
                if (checkbox && checkbox.checked) {
                    temItens = true; var li = document.createElement("li");
                    li.innerText = r.querySelector(".nome-prod").innerText.replace(/(\r\n|\n|\r)/gm, " ").trim();
                    ulCompras.appendChild(li);
                }
            });
            areaCompras.style.display = temItens ? "block" : "none";
        }

        function gerarTextoCompras() {
            var t = `*LISTA DE COMPRAS ${obterDataAmanha()}*\n\n`;
            document.querySelectorAll("#lista-itens tr").forEach(r => {
                var check = r.querySelector("input[type='checkbox']");
                if (check && check.checked) { t += `${r.querySelector(".nome-prod").innerText.replace(/(\r\n|\n|\r)/gm, " ").trim()}\n`; }
            });
            return t;
        }

        function copiarCompras() { copiarParaClipboard(gerarTextoCompras()); }
        function compartilharComprasZap() { window.open("https://wa.me/?text=" + encodeURIComponent(gerarTextoCompras()), '_blank'); }

        function gerarTextoEstoque() {
            var t = `*ESTOQUE ${obterDataAtual()}*\n\n`;
            document.querySelectorAll("#lista-itens tr").forEach(r => {
                var c = r.querySelectorAll("td"); var nome = c[1].innerText.replace(/(\r\n|\n|\r)/gm, " ").trim();
                var qTxt = c[2].querySelector("input").value.trim(); var unidade = c[3].querySelector("select").options[c[3].querySelector("select").selectedIndex].text;
                if(qTxt !== "") { t += `${nome}: ${qTxt} ${unidade}\n`; } else { t += `${nome}:   ${unidade}\n`; }
            });
            return t;
        }

        function copiarEstoque() { copiarParaClipboard(gerarTextoEstoque()); }
        function compartilharEstoque() { window.open("https://wa.me/?text=" + encodeURIComponent(gerarTextoEstoque()), '_blank'); }

        function copiarParaClipboard(texto) {
            darFeedback();
            if (navigator.clipboard && window.isSecureContext) { 
                navigator.clipboard.writeText(texto).then(() => mostrarToast("Copiado com sucesso! ‚úÖ")).catch(() => copiarFallback(texto)); 
            } else { copiarFallback(texto); }
        }

        function copiarFallback(texto) {
            var textArea = document.createElement("textarea"); textArea.value = texto; textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try { document.execCommand('copy'); mostrarToast("Copiado com sucesso! ‚úÖ"); } catch (err) { mostrarAlertaElegante("Erro ao copiar."); }
            document.body.removeChild(textArea);
        }

        function salvarEOrdenar() { salvarDados(); reordenarTabela(); atualizarDropdown(); }
        
        function reordenarTabela() {
            var rows = Array.from(tbody.querySelectorAll("tr"));
            rows.sort((a, b) => a.querySelector(".nome-prod").innerText.localeCompare(b.querySelector(".nome-prod").innerText));
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function removerItem(b) { 
            mostrarConfirmacao("Deseja realmente remover este item?", () => {
                b.parentElement.parentElement.remove(); salvarDados(); atualizarDropdown(); mostrarToast("Removido üóëÔ∏è");
            }); 
        }
        
        function adicionarManual() {
            var p = document.getElementById("novoProduto").value.trim();
            var q = document.getElementById("novoQtd").value.trim();
            var u = document.getElementById("novoUnidade").value;
            if (!p) { mostrarToast("‚ö†Ô∏è Digite o nome do produto!"); return; }
            darFeedback();
            inserirLinha(p, q, u, false); salvarEOrdenar(); mostrarToast("Adicionado! ‚ûï");
            document.getElementById("novoProduto").value = ""; document.getElementById("novoQtd").value = "";
        }
        
        function filtrarGeral() {
            var tBusca = buscaInput.value.toLowerCase(); var tSelect = selectFiltro.value.toLowerCase();
            document.querySelectorAll("#lista-itens tr").forEach(r => {
                var nome = r.querySelector(".nome-prod").innerText.toLowerCase();
                r.style.display = (nome.includes(tBusca) && (tSelect === "" || nome === tSelect)) ? "" : "none";
            });
        }
        
        function atualizarDropdown() {
            var v = selectFiltro.value; selectFiltro.innerHTML = '<option value="">üìÇ ITENS</option>';
            var nomes = []; document.querySelectorAll(".nome-prod").forEach(td => nomes.push(td.innerText.replace(/(\r\n|\n|\r)/gm, " ").trim()));
            nomes.sort().forEach(n => { var o = document.createElement("option"); o.value = n; o.text = n; selectFiltro.add(o); });
            selectFiltro.value = v;
        }
        
        function resetarTudo() { 
            mostrarConfirmacao("ATEN√á√ÉO: Isso apagar√° tudo e carregar√° a lista padr√£o do sistema. Confirmar?", () => { 
                localStorage.removeItem("estoqueDados_v3"); location.reload(); 
            }); 
        }

        function iniciarNovoDia() {
            mostrarConfirmacao("INICIAR NOVO DIA?\nIsso limpar√° as quantidades e desmarcar√° as compras.", () => {
                var dados = JSON.parse(localStorage.getItem("estoqueDados_v3") || "[]");
                dados.forEach(item => { item.q = ""; item.c = false; });
                localStorage.setItem("estoqueDados_v3", JSON.stringify(dados)); location.reload();
            }, 'sucesso');
        }

        function salvarListaNoCelular() {
            var dados = localStorage.getItem("estoqueDados_v3");
            if (!dados || dados === "[]") { mostrarToast("‚ö†Ô∏è N√£o h√° dados para salvar!"); return; }
            darFeedback();
            var blob = new Blob([dados], { type: "application/json" });
            var url = URL.createObjectURL(blob); var a = document.createElement("a"); a.href = url;
            a.download = "MEU_ESTOQUE_" + obterDataAtual().replace(/\//g, "-") + ".json";
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            mostrarToast("Backup salvo no celular! üíæ");
        }

        function carregarListaDoCelular(event) {
            var file = event.target.files[0]; if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var dados = JSON.parse(e.target.result);
                    if (Array.isArray(dados)) { 
                        localStorage.setItem("estoqueDados_v3", JSON.stringify(dados)); 
                        mostrarAlertaElegante("Lista carregada com sucesso! A p√°gina ser√° atualizada.");
                        setTimeout(() => location.reload(), 1500); 
                    } else { mostrarAlertaElegante("Arquivo inv√°lido."); }
                } catch (erro) { mostrarAlertaElegante("Erro ao ler o arquivo."); }
            };
            reader.readAsText(file);
        }

        function autoPreencherUnidade() {
            var inputNome = document.getElementById("novoProduto").value.toLowerCase().trim();
            if (inputNome.length < 2) return; 
            var unidadeEncontrada = null;
            var matchPadrao = produtosPadrao.find(p => p.split("|")[0].toLowerCase().startsWith(inputNome));
            if (matchPadrao) { unidadeEncontrada = matchPadrao.split("|")[1]; } else {
                var rows = Array.from(tbody.querySelectorAll("tr"));
                var matchTabela = rows.find(r => r.querySelector(".nome-prod").innerText.toLowerCase().startsWith(inputNome));
                if (matchTabela) { unidadeEncontrada = matchTabela.querySelector(".select-tabela").value; }
            }
            if (unidadeEncontrada) {
                var selectUnid = document.getElementById("novoUnidade");
                if (Array.from(selectUnid.options).some(opt => opt.value === unidadeEncontrada)) { selectUnid.value = unidadeEncontrada; }
            }
        }

        function pararEfeitoGravacao() {
            var btnMic = document.getElementById("btn-mic");
            var inputProduto = document.getElementById("novoProduto");
            btnMic.classList.remove("mic-ativo"); btnMic.innerText = "üéôÔ∏è"; inputProduto.placeholder = "Item"; 
        }

        // ==========================================
        // MICROFONE CORRIGIDO (LIVRE DE CONFLITO DE √ÅUDIO)
        // ==========================================
        function iniciarReconhecimentoVoz() {
            // Vibra no Android, mas N√ÉO roda a fun√ß√£o de √°udio para n√£o travar o microfone da Apple
            if (navigator.vibrate) { navigator.vibrate(15); } 
            
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { mostrarAlertaElegante("Seu navegador n√£o suporta voz.\nTente acessar pelo Safari ou Google Chrome."); return; }
            
            var recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR'; 
            recognition.continuous = false; 
            recognition.interimResults = false;

            var btnMic = document.getElementById("btn-mic");
            var inputProduto = document.getElementById("novoProduto");
            
            btnMic.classList.add("mic-ativo"); 
            btnMic.innerText = "üéß"; 
            inputProduto.placeholder = "üó£Ô∏è Fale agora..."; 
            inputProduto.value = ""; 

            recognition.onerror = function(event) {
                pararEfeitoGravacao();
                if(event.error === 'not-allowed') {
                    mostrarAlertaElegante("üö´ Microfone Bloqueado!\n\nVerifique se a p√°gina tem o cadeado de seguran√ßa (HTTPS) ou se o navegador tem permiss√£o nas configura√ß√µes.");
                } else if(event.error === 'network') {
                    mostrarAlertaElegante("üì∂ Erro de Rede!\n\nO reconhecimento de voz da Apple/Google precisa de internet para traduzir o que voc√™ diz.");
                } else if(event.error !== 'no-speech') { 
                    mostrarToast("Erro na voz: " + event.error); 
                }
            };

            recognition.onresult = function(event) {
                // Toca o som elegante s√≥ DEPOIS que ele terminar de escutar
                darFeedback();
                var fala = event.results[0][0].transcript.toLowerCase();
                pararEfeitoGravacao(); processarVoz(fala);
            };

            recognition.onend = function() { pararEfeitoGravacao(); };
            
            try { recognition.start(); } catch(e) { pararEfeitoGravacao(); mostrarToast("Erro ao iniciar a grava√ß√£o."); }
        }

        function processarVoz(fala) {
            fala = fala.replace(/^(adicionar|colocar|comprar|preciso de)\s+/i, '');
            var qtd = ""; var unid = "";
            var numerosStr = {"um": "1", "uma": "1", "dois": "2", "duas": "2", "tr√™s": "3", "tres": "3", "quatro": "4", "cinco": "5", "seis": "6", "meio": "1/2", "meia": "1/2"};
            var unidadesStr = {"quilos": "kg", "quilo": "kg", "kg": "kg", "gramas": "g", "grama": "g", "unidades": "uni", "unidade": "uni", "pacotes": "pct", "pacote": "pct", "caixas": "cx", "caixa": "cx", "fardos": "bld", "fardo": "bld"};
            var palavras = fala.split(" "); var produtoWords = [];
            for (var i = 0; i < palavras.length; i++) {
                var p = palavras[i].toLowerCase();
                if (unidadesStr[p] && !unid) { unid = unidadesStr[p]; continue; }
                if ((!isNaN(p) || numerosStr[p]) && !qtd) { qtd = isNaN(p) ? numerosStr[p] : p; continue; }
                if (p === "de" && (unid || qtd) && i > 0 && (unidadesStr[palavras[i-1]] || !isNaN(palavras[i-1]) || numerosStr[palavras[i-1]])) { continue; }
                produtoWords.push(palavras[i]);
            }
            var produto = produtoWords.join(" ");
            if (produto.length > 0) produto = produto.charAt(0).toUpperCase() + produto.slice(1);
            document.getElementById("novoProduto").value = produto;
            if (qtd) document.getElementById("novoQtd").value = qtd;
            if (unid) { document.getElementById("novoUnidade").value = unid; } else { autoPreencherUnidade(); }
        }
        iniciarApp();
    </script>
</body>
</html>